ご提示いただいた課題（一極集中、内部の偏り）を解決するための、新しいシステムモデルを提案します。

従来の手法（Winner-Takes-All：重要度順に満タンになるまで割り当てる）を廃止し、**「重要度に応じた予算配分（Proportional Allocation）」**と**「構造と密度のハイブリッドサンプリング（Structure-Density Sampling）」**を組み合わせたモデルへ移行します。

---

# 提案システムモデル：Proportional Semantic Sampling (PSS)

このモデルは、**「どれだけ重要か」に応じて通信リソース（ピクセル数）を分配**し、各セグメント内では**「輪郭（Edge）」を確保した上で「内部（Body）」をまばらにサンプリング**することで、画像全体の意味的な復元率を最大化します。

## 1. 全体フロー

処理は大きく2段階に分かれます。

1. **Global Budgeting (全体予算配分):** 各セグメントに何ピクセル送るかを決定する。
2. **Local Sampling (局所サンプリング):** 決められたピクセル数を、セグメント内のどこから取得するか決定する。

---

## 2. Global Budgeting: 重要度比例配分

特定のセグメント（例：手前のベッドだけ）が予算を独占するのを防ぎます。

### A. 重要度スコアの定義 ()

単なるCLIPスコアの変化量ではなく、**面積あたりの重要度密度**を重視します（巨大な背景がスコアを稼ぐのを防ぐため）。

*(既存ロジックを踏襲)*

### B. 予算の配分 ()

全予算（ = 画像画素数  送信率 0.1）を、スコアの比率で分配します。

ただし、以下の制約を加えます：

1. **上限キャップ:** 配分量  がセグメント面積  を超える場合、 とし、余剰分は他のセグメントへ再配分する（Water-filling algorithm的アプローチ）。
2. **足切り (Optional):** 極端にスコアが低いノイズのようなセグメントは計算対象外とする。

これにより、**「重要な物体はより多く、そうでない物体も少しは」**データが送られるようになり、一極集中を防ぎます。

---

## 3. Local Sampling: エッジ優先・内部拡散

配分された予算  を使って、セグメント  のどのピクセルを送るかを決定します。
「上から順」ではなく、**情報の疎性（Sparsity）**を意識して配置します。

### ステップ1: エッジ（境界線）の確保

まず、物体の形状を決定づける「エッジ」を優先します。

* **エッジ集合 ():** モルフォロジー勾配により抽出。
* **エッジ配分 ():** 
* もし予算がエッジ画素数より少なければ、エッジの中からランダム、または勾配が強い順に  個を選択して終了。



### ステップ2: 内部（Body）の拡散サンプリング

エッジを取り切っても予算が余っている場合（残り予算 ）、内部領域を埋めます。
ここで「上半分だけ埋まる」のを防ぐため、**空間的に分散（Scatter）**させます。

* **内部集合 ():** セグメント全体からエッジを除いた部分。
* **サンプリング手法:**
* **Random Permutation (推奨):** 内部ピクセルの座標リストをシャッフルし、先頭から  個を取得する。これにより、確率的に全体へ均一に散らばる（一様分布）。
* **Floyd-Steinberg Dithering / Blue Noise:** 計算コストが高いが、より美しく散らす手法（今回はRandom Permutationで十分）。



---

## 4. 期待される効果の比較

現在のモデルと新モデルの違いを視覚的に表現すると以下のようになります。

| 特徴 | 現在の手法 (Winner-Takes-All + Scanline) | 新モデル (Proportional + Scatter) |
| --- | --- | --- |
| **予算配分** | **上位1〜2個のセグメントが独占**。<br>

<br>下位セグメントは0ピクセル。 | **全セグメントに薄く広く配分**。<br>

<br>重要度が高いほど密度が高い。 |
| **セグメント内** | **エッジ＋上部のみ密集**。<br>

<br>下部は欠損する。 | **エッジ完備 ＋ 内部は砂嵐状**。<br>

<br>全体の色・テクスチャ情報が伝わる。 |
| **復元への影響** | 重要な物体は完璧だが、背景や脇役が崩壊する。<br>

<br>拡散モデルが「無い部分」を幻覚しやすい。 | 全体にヒントがあるため、拡散モデルが<br>

<br>隙間を埋めやすく、整合性が取れやすい。 |

### 実装に向けた変更点（次回の指示用）

次回、以下のロジック変更を依頼してください。

1. `create_clip_priority_mask` 内の `sort` して `break` するループを廃止。
2. 代わりに、全セグメントのスコア合計を出し、係数 `weight = score / total_score` を計算。
3. `target_pixels = total_budget * weight` で各セグメントの割当数を算出。
4. 各セグメントのマスク生成時：
* エッジを取得。
* 内部（非エッジ）を取得。
* 内部ピクセルのインデックスを `np.random.shuffle` でランダム化。
* エッジ + シャッフルされた内部の先頭から、割当数分だけ `True` にする。



このモデルでよろしければ、次のステップでコード修正を行います。